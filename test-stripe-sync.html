<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico Stripe</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #fff;
    }
    .container {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    h1 {
      color: #3b82f6;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #888;
      margin-bottom: 30px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
    }
    .success {
      background: #10b981;
    }
    .success:hover {
      background: #059669;
    }
    #output {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .info-box {
      background: #1e3a5f;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .warning-box {
      background: #5f3a1e;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .success-box {
      background: #1e5f3a;
      border-left: 4px solid #10b981;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico de Sincroniza√ß√£o Stripe</h1>
    <p class="subtitle">Ferramenta para diagnosticar e corrigir problemas de sincroniza√ß√£o</p>

    <div class="info-box">
      <strong>üìã Instru√ß√µes:</strong><br>
      1. Fa√ßa login no sistema primeiro<br>
      2. Clique em "Diagnosticar" para verificar o status<br>
      3. Se necess√°rio, clique em "Sincronizar" para corrigir
    </div>

    <div>
      <button id="diagnoseBtn" onclick="diagnose()">üîç Diagnosticar</button>
      <button id="syncBtn" onclick="syncCustomer()" class="success" disabled>‚úÖ Sincronizar Customer + Subscription</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://rslpleprodloodfsaext.supabase.co';
    let diagnosisData = null;

    async function getSession() {
      const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzbHBsZXByb2RsbG9vZGZzYWV4dCIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzQ2NzQ2NDU4LCJleHAiOjIwNjIzMjI0NTh9.sTi4VYmZ5S0IVMNz2tWvn0bOCx4G0AcZTkP-K0WOpNk',
          'Authorization': `Bearer ${localStorage.getItem('supabase.auth.token')}`
        }
      });

      if (!response.ok) {
        const authData = JSON.parse(localStorage.getItem('sb-rslpleprodloodfsaext-auth-token') || '{}');
        return authData.access_token;
      }

      return localStorage.getItem('supabase.auth.token');
    }

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      output.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    async function diagnose() {
      const btn = document.getElementById('diagnoseBtn');
      const output = document.getElementById('output');

      btn.disabled = true;
      btn.innerHTML = 'üîç Diagnosticando<span class="loading"></span>';
      output.innerHTML = '';

      log('Iniciando diagn√≥stico...');

      try {
        const authData = JSON.parse(localStorage.getItem('sb-rslpleprodloodfsaext-auth-token') || '{}');
        const token = authData.access_token;

        if (!token) {
          throw new Error('Voc√™ precisa fazer login primeiro!');
        }

        log('Token de autentica√ß√£o encontrado');
        log('Chamando edge function diagnose-stripe-customer...');

        const response = await fetch(`${SUPABASE_URL}/functions/v1/diagnose-stripe-customer`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();
        diagnosisData = data;

        log('Resposta recebida!', 'success');
        log('\nüìä RESULTADO DO DIAGN√ìSTICO:\n' + '='.repeat(50));
        log(`\nüë§ User ID: ${data.user_id}`);
        log(`üìß Email: ${data.email}`);
        log(`\nüè¢ STRIPE:`);
        log(`   Customers encontrados: ${data.stripe_customers?.length || 0}`);

        if (data.stripe_customers && data.stripe_customers.length > 0) {
          data.stripe_customers.forEach((customer, idx) => {
            log(`\n   Customer #${idx + 1}:`);
            log(`   - ID: ${customer.customer_id}`);
            log(`   - Email: ${customer.email}`);
            log(`   - Criado em: ${new Date(customer.created).toLocaleString()}`);
            log(`   - Subscriptions: ${customer.subscriptions.length}`);

            customer.subscriptions.forEach((sub, subIdx) => {
              log(`\n     Subscription #${subIdx + 1}:`);
              log(`     - ID: ${sub.subscription_id}`);
              log(`     - Status: ${sub.status}`);
              log(`     - Price ID: ${sub.price_id}`);
              log(`     - Termina em: ${new Date(sub.current_period_end).toLocaleString()}`);
            });
          });
        }

        log(`\nüíæ BANCO DE DADOS:`);
        log(`   Customer registrado: ${data.database_customer ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
        if (data.database_customer) {
          log(`   - Customer ID: ${data.database_customer.customer_id}`);
        }

        log(`   Subscription registrada: ${data.database_subscription ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
        if (data.database_subscription) {
          log(`   - Status: ${data.database_subscription.status}`);
          log(`   - Tokens totais: ${data.database_subscription.tokens_total || 0}`);
          log(`   - Tokens usados: ${data.database_subscription.tokens_used || 0}`);
        }

        log(`\nüîß A√á√ÉO NECESS√ÅRIA: ${data.needs_sync ? '‚ö†Ô∏è SINCRONIZA√á√ÉO NECESS√ÅRIA' : '‚úÖ TUDO OK'}`);

        if (data.needs_sync) {
          document.getElementById('syncBtn').disabled = false;
          log('\n‚ö†Ô∏è Clique no bot√£o "Sincronizar" para corrigir!', 'warning');
        } else if (!data.database_customer && data.stripe_customers.length === 0) {
          log('\n‚ùå PROBLEMA: Nenhum customer encontrado no Stripe!', 'error');
          log('Isso significa que o checkout n√£o foi conclu√≠do ou o webhook falhou.', 'error');
        }

      } catch (error) {
        log(`Erro: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîç Diagnosticar';
      }
    }

    async function syncCustomer() {
      if (!diagnosisData || !diagnosisData.stripe_customers || diagnosisData.stripe_customers.length === 0) {
        log('‚ùå Nenhum customer para sincronizar!', 'error');
        return;
      }

      const btn = document.getElementById('syncBtn');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Sincronizando<span class="loading"></span>';

      try {
        const authData = JSON.parse(localStorage.getItem('sb-rslpleprodloodfsaext-auth-token') || '{}');
        const token = authData.access_token;

        if (!token) {
          throw new Error('Voc√™ precisa fazer login primeiro!');
        }

        log('\nüîÑ Iniciando sincroniza√ß√£o completa...');
        log('Usando edge function force-sync-customer...');

        const response = await fetch(`${SUPABASE_URL}/functions/v1/force-sync-customer`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao sincronizar');
        }

        log('‚úÖ SINCRONIZA√á√ÉO CONCLU√çDA COM SUCESSO!', 'success');
        log('\nüìä RESULTADO:');
        log(`   Customer ID: ${data.customer_id}`);
        log(`   Subscription ID: ${data.subscription_id}`);
        log(`   Status: ${data.status}`);
        log(`   Price ID: ${data.price_id}`);
        log(`   Tokens do plano: ${data.plan_tokens}`);
        log(`   Tokens totais: ${data.tokens_total}`);
        log('\n‚ú® Atualize a p√°gina principal para ver seus tokens!', 'success');

      } catch (error) {
        log(`‚ùå Erro na sincroniza√ß√£o: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚úÖ Sincronizar Customer + Subscription';
      }
    }
  </script>
</body>
</html>
