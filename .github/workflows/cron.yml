name: Process Transcription Queue

# IMPORTANTE: Este workflow deve estar no repositÃ³rio arpj-v1
# RepositÃ³rio: https://github.com/eldanielsantos-git/arpj-v1

on:
  schedule:
    # Executa a cada minuto para garantir o processamento contÃ­nuo
    - cron: '*/1 * * * *'
  # Permite a execuÃ§Ã£o manual a partir da aba "Actions" no GitHub para testes
  workflow_dispatch:

jobs:
  process-queue:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Environment Check
        run: |
          echo "ğŸ” Environment Check"
          echo "ğŸ“ Repository: arpj-v1"
          echo "ğŸ• Timestamp: $(date)"
          echo "ğŸŒ Runner: $(uname -a)"
          echo "ğŸ“Š Memory: $(free -h)"
          echo "ğŸ’¾ Disk: $(df -h)"
          echo "ğŸ”‘ SUPABASE_URL length: ${#SUPABASE_URL}"
          echo "ğŸ”‘ SERVICE_ROLE_KEY length: ${#SUPABASE_SERVICE_ROLE_KEY}"
          
          # Verificar se estamos no repositÃ³rio correto
          if [ "${{ github.repository }}" != "eldanielsantos-git/arpj-v1" ]; then
            echo "âŒ WRONG REPOSITORY! Expected: eldanielsantos-git/arpj-v1, Got: ${{ github.repository }}"
            exit 1
          else
            echo "âœ… Correct repository: ${{ github.repository }}"
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
      - name: Process one queue item via Edge Function
        run: |
          echo "ğŸš€ Calling Edge Function..."
          response=$(curl -w "%{http_code}" -s -o /tmp/response.json -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/process-queue-item" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")
          
          echo "ğŸ“Š HTTP Status Code: $response"
          echo "ğŸ“„ Response body:"
          cat /tmp/response.json
          
          if [ "$response" != "200" ]; then
            echo "âŒ Edge Function call failed with status $response"
            exit 1
          else
            echo "âœ… Edge Function call successful"
          fi
        continue-on-error: true
        
      - name: Check queue status (optional)
        run: |
          echo "ğŸ“Š Checking queue status..."
          curl -s -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/transcription_queue?select=status,count()&group=status" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" || echo "Queue status check failed"
        continue-on-error: true