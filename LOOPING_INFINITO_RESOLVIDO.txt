===============================================
üîÑ LOOPING INFINITO - PROBLEMA IDENTIFICADO
===============================================

SINTOMAS:
---------
‚úó Processo mostra 100% completo
‚úó Cards ficam em looping infinito
‚úó Edge function repetindo constantemente:
  - "Nenhum prompt dispon√≠vel para processar"
  - "Tentando adquirir lock..."
  - "Iniciando processamento..."

CAUSA RAIZ:
-----------
‚ùå Edge function usando tabela ERRADA
   .from('analysis_results')  ‚Üê Tabela antiga que n√£o existe

‚úÖ Deveria usar:
   .from('forensic_analysis_results')  ‚Üê Tabela atual

IMPACTO:
--------
‚Ä¢ 9 ocorr√™ncias da tabela errada no c√≥digo
‚Ä¢ Queries falhando silenciosamente
‚Ä¢ Sistema n√£o detecta an√°lises conclu√≠das
‚Ä¢ Loop infinito de tentativas

SOLU√á√ÉO APLICADA:
-----------------
‚úÖ Arquivo corrigido:
   supabase/functions/process-next-prompt/index.ts

‚úÖ Todas 9 ocorr√™ncias substitu√≠das:
   - Linha 221: Check status completo
   - Linha 374: Update status running (File API)
   - Linha 496: Update resultado (chunks)
   - Linha 591: Update resultado (File API)
   - Linha 614: Check prompts restantes (File API)
   - Linha 683: Update status running (Base64)
   - Linha 744: Update resultado (Base64)
   - Linha 767: Check prompts restantes (Base64)
   - Linha 827: Update erro

PR√ìXIMOS PASSOS:
----------------
1. ‚ö†Ô∏è CR√çTICO: Fazer deploy da edge function
   - Use o Supabase Dashboard
   - Ou CLI: supabase functions deploy process-next-prompt

2. Corrigir processos travados no banco:
   
   -- Verificar status
   SELECT 
     p.id, p.status,
     COUNT(CASE WHEN far.status = 'completed' THEN 1 END) as completed,
     COUNT(*) as total
   FROM processos p
   LEFT JOIN forensic_analysis_results far ON far.processo_id = p.id
   WHERE p.id = '2bf5d35a-2eb2-406c-b3ac-311fe459eb0a'
   GROUP BY p.id, p.status;

   -- Marcar como completed se todas an√°lises completaram
   UPDATE processos
   SET status = 'completed', analysis_completed_at = NOW()
   WHERE id = '2bf5d35a-2eb2-406c-b3ac-311fe459eb0a'
     AND status != 'completed';

3. Testar com novo processo (< 1000 p√°ginas)

RESULTADO ESPERADO:
-------------------
‚úì Processo processa normalmente
‚úì Cards mostram an√°lises completas
‚úì SEM looping infinito
‚úì Status muda para "completed" automaticamente

DOCUMENTA√á√ÉO:
-------------
Ver detalhes em: INFINITE_LOOP_FIX.md

===============================================
